rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // =================================
    // Users Collection
    // =================================
    match /users/{userId} {
      // Allow users to create their own profile
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow users to read and update their own profile data
      allow read, update: if request.auth != null && request.auth.uid == userId;

      // Allow admins to read and write any user profile
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }

    // =================================
    // User-Owned Collections
    // =================================
    // This rule applies to collections where each document has a `userId` field.
    match /{collection}/{docId} where collection in ['tradingAccounts', 'withdrawals', 'orders', 'notifications', 'feedbackResponses'] {
      // Allow creation if the userId on the document matches the creator's ID
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Allow read access only to the user who owns the document
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Allow admins to read/write any document in these collections
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }

    // =================================
    // Public Read-Only Collections
    // =================================
    // This rule applies to data that any user (even unauthenticated) can see.
    match /{collection}/{docId} where collection in ['brokers', 'productCategories', 'products', 'clientLevels', 'blogPosts'] {
      allow read: if true;
      
      // Allow admins to write/delete this data
      allow write, delete: if request.auth != null && request.auth.token.admin == true;
    }

    // =================================
    // Admin-Only Collections
    // =================================
    match /{collection}/{docId} where collection in ['activityLogs', 'adminNotifications', 'feedbackForms', 'counters', 'settings'] {
      allow read, write, create, delete: if request.auth != null && request.auth.token.admin == true;
    }
  }
}
